var itsuData = [
    {
         "id": 0, 
       "name": 'Aldgate', 
    "address": '77 Aldgate High Street',
   "address2": 'London, EC3N 1BD' , 
        "lat": 51.513809,
        "lng": -0.075476
    },
    {
         "id": 1, 
       "name": "Bankside",
    "address": "The Harlequin Building, 65 Southwark St",
   "address2": "London, SE1 0HR",
        "lat": 51.5050073, 
        "lng": -0.0976345 
    },
    {
         "id": 2,
       "name": "Berkeley Square",
    "address": "Unit 4, Lansdowne House, 55 Berkeley Square",
   "address2": "London, W1J 6ER",
        "lat": 51.5087591,
        "lng": -0.1447029
    },
    {
         "id": 3,
       "name": "Bishopsgate (Broadgate Arcade)",
    "address": "10-11 Broadgate Arcade, 155 Bishopsgate",
   "address2": "London, EC2M 3TQ",
        "lat": 51.5183215,
        "lng": -0.0843028
    },
    {
         "id": 4,
       "name": "Bishopsgate [2]",
    "address": "55 Bishopsgate",
   "address2": "London, EC2N 3AS",
        "lat": 51.5154341,
        "lng": -0.0829891
    },
    {
         "id": 5,
       "name": "Brighton",
    "address": "68-70 North Street",
   "address2": "Brighton, UK, BN1",
        "lat": 50.8234628,
        "lng": -0.1434566
    },
    {
         "id": 6,
       "name": "Broadwick Street",
    "address": "31 Broadwick Street",
   "address2": "London, W1F 0DG",
        "lat": 51.513500,
        "lng": -0.136187
    },
    {
         "id": 7,
       "name": "Brunswick",
    "address": "The Brunswick Centre, Bloomsbury",
   "address2": "London, WC1N 1AF",
        "lat": 51.5248459,
        "lng": -0.1239382
    },
    {
         "id": 8,
       "name": "Cabot Place",
    "address": "Level 2, Cabot Place East, Canary Wharf",
   "address2": "London, E14 4QT",
        "lat": 51.5051802,
        "lng": -0.0216597
    },
    {
         "id": 9,
       "name": "Canada Place (Deli 1)",
    "address": "Canada Place Mall, Canary Wharf",
   "address2": "London, E14 5NY",
        "lat": 51.5030781,
        "lng": -0.0185951
    },
    {
         "id": 10,
       "name": "Canada Place (Deli 2)",
    "address": "Canada Place Mall, Canary Wharf",
   "address2": "London, E14 5EQ",
        "lat": 51.5046219,
        "lng": -0.0162947
    },
    {
         "id": 11,
       "name": "Cannon Street (Mansion House)",
    "address": "30 - 40 Cannon Street",
   "address2": "London, EC4N 6JD",
        "lat": 51.512459,
        "lng": -0.093742
    },
    {
         "id": 12,
       "name": "Chancery Lane",
    "address": "19 Holborn",
   "address2": "London, EC1N 2JD",
        "lat": 51.518260,
        "lng": -0.109828
    },
    {
         "id": 13,
       "name": "Cheapside",
    "address": "Unit A, 107 Cheapside",
   "address2": "London, EC2V 6DN",
        "lat": 51.514113,
        "lng": -0.094139
    },
    {
         "id": 14,
       "name": "Copthall Avenue",
    "address": "2 Copthall Avenue",
   "address2": "London, EC2R 7DA",
        "lat": 51.515647,
        "lng": -0.087827
    },
    {
         "id": 15,
       "name": "Cowcross",
    "address": "9-13 Cowcross Street, Farringdon",
   "address2": "London, EC1M 6DR",
        "lat": 51.520096,
        "lng": -0.102703
    },
    {
         "id": 16,
       "name": "Eastcastle Street",
    "address": "40 Eastcastle Street",
   "address2": "London, W1W 8DT",
        "lat": 51.5165947,
        "lng": -0.1394255
    },
    {
         "id": 17,
       "name": "Fleet Street",
    "address": "130 Fleet Street",
   "address2": "London, EC4A 2BH",
        "lat": 51.5143942,
        "lng": -0.1064386
    },
    {
         "id": 18,
       "name": "Gracechurch Street",
    "address": "21 Gracechurch Street",
   "address2": "London, EC3V 0BG",
        "lat": 51.5126351,
        "lng": -0.0846663
    },
    {
         "id": 19,
       "name": "Great Eastern Street",
    "address": "49 - 51 Great Eastern Street",
   "address2": "London, EC2A 3HP",
        "lat": 51.5244744,
        "lng": -0.0807117
    },
    {
         "id": 20,
       "name": "Great Peter Street",
    "address": "16 Great Peter Street",
   "address2": "London, SW1P 2BX",
        "lat": 51.4970531,
        "lng": -0.1297619
    },
    {
         "id": 21,
       "name": "Grosvenor",
    "address": "4 Grosvenor Street",
   "address2": "London, W1K4PZ",
        "lat": 51.5122474,
        "lng": -0.1454249
    },
    {
         "id": 22,
       "name": "Hanover Square",
    "address": "1 Hanover Square",
   "address2": "London, W1S 1HA",
        "lat": 51.5133884,
        "lng": -0.1430871
    },
    {
         "id": 23,
       "name": "High Holborn",
    "address": "236 High Holborn",
   "address2": "London, WC1V 7DN",
        "lat": 51.51764,
        "lng": -0.119161
    },
    {
         "id": 24,
       "name": "Islington",
    "address": "21 Parkfield Street",
   "address2": "London, N1 0PS",
        "lat": 51.534148,
        "lng": -0.105451
    },
    {
         "id": 25,
       "name": "Jubilee Place",
    "address": "28a Bank Street",
   "address2": "London, E14 5NY",
        "lat": 51.5030274,
        "lng": -0.0200032
    },
    {
         "id": 26,
       "name": "King William Street (Monument)",
    "address": "18 King William Street",
   "address2": "London, EC4N 7BP",
        "lat": 51.5112531,
        "lng": -0.0874304
    },
    {
         "id": 27,
       "name": "Lime Street",
    "address": "Willis Building, 51 Lime Street",
   "address2": "London, EC3M 7DQ",
        "lat": 51.512949,
        "lng": -0.082022
    },
    {
         "id": 28,
       "name": "Ludgate Hill",
    "address": "38-40 Ludgate Hill",
   "address2": "London, EC4M 7DE",
        "lat": 51.5140738,
        "lng": -0.1016381
    },
    {
         "id": 29,
       "name": "More London (London Bridge)",
    "address": "7 More London",
   "address2": "London, SE1 2TU",
        "lat": 51.504723,
        "lng": -0.080928
    },
    {
         "id": 30,
       "name": "New Oxford Street",
    "address": "74 New Oxford Street",
   "address2": "London, WC1A 1EU",
        "lat": 51.517015,
        "lng": -0.127618
    },
    {
         "id": 31,
       "name": "Old Broad Street",
    "address": "57 Old Broad Street",
   "address2": "London, EC2M 1RX",
        "lat": 51.516643,
        "lng": -0.083227
    },
    {
         "id": 32,
       "name": "Oxford",
    "address": "36 Cornmarket Street",
   "address2": "Oxford, OX13EZ",
        "lat": 51.7537212,
        "lng": -1.2589947
    },
    {
         "id": 33,
       "name": "Paddington",
    "address": "Sheldon Square, Paddington Central",
   "address2": "London, W2 ",
        "lat": 51.5197074,
        "lng": -0.1807822
    },
    {
         "id": 34,
       "name": "Paternoster Square",
    "address": "4-6 Paternoster Row",
   "address2": "London, EC4M 7EJ",
        "lat": 51.5148528,
        "lng": -0.0981035
    },
    {
         "id": 35,
       "name": "Piccadilly",
    "address": "167 Piccadilly",
   "address2": "London, W1J 9EG",
        "lat": 51.5079491,
        "lng": -0.1398712
    },
    {
         "id": 36,
       "name": "Regents Place (Hampstead Road)",
    "address": "15-20 Hampstead Road",
   "address2": "London, United Kingdom, NW1 3JA",
        "lat": 51.5258512,
        "lng": -0.1390626
    },
    {
         "id": 37,
       "name": "Richmond",
    "address": "39 George St, Richmond",
   "address2": "Surrey, TW9 1HY",
        "lat": 51.4606629,
        "lng": -0.3043824
    },
    {
         "id": 38,
       "name": "Sackville Street",
    "address": "27 Sackville Street",
   "address2": "London, W1S 3DT",
        "lat": 51.510068,
        "lng": -0.138687
    },
    {
         "id": 39,
       "name": "Saint Mary Axe",
    "address": "25 St Mary Axe",
   "address2": "London, EC3A 8AA",
        "lat": 51.514832,
        "lng": -0.080869
    },
    {
         "id": 40,
       "name": "Spital Square",
    "address": "30 Spital Square",
   "address2": "London, E1 6DX",
        "lat": 51.5206651,
        "lng": -0.0773351
    },
    {
         "id": 41,
       "name": "Strand",
    "address": "82 - 83 The Strand",
   "address2": "London, WC2R 0RE",
        "lat": 51.5111476,
        "lng": -0.1194893
    },
    {
         "id": 42,
       "name": "Tottenham Court Road",
    "address": "103 Tottenham Court Road",
   "address2": "London, W1T 4EZ",
        "lat": 51.522716,
        "lng": -0.136309
    },
    {
         "id": 43,
       "name": "Tottenham Court Road [2]",
    "address": "53 - 54 Tottenham Court Road",
   "address2": "London, W1T 2EQ",
        "lat": 51.519477,
        "lng": -0.133470
    },
    {
         "id": 44,
       "name": "Upper Regent Street",
    "address": "313 Regent Street",
   "address2": "London, W1B 2HP",
        "lat": 51.517080,
        "lng": -0.142752
    },
    {
         "id": 45,
       "name": "Victoria",
    "address": "163 Victoria Street",
   "address2": "London, SW1E 5NA",
        "lat": 51.4965728,
        "lng": -0.1431374
    },
    {
         "id": 46,
       "name": "itsu (dining) Chelsea",
    "address": "118 Draycott Avenue, Chelsea",
   "address2": "London, SW3 3AE",
        "lat": 51.4924632,
        "lng": -0.1647067
    },
    {
         "id": 47,
       "name": "itsu (dining) Notting Hill",
    "address": "100 Notting Hill Gate",
   "address2": "London, W11 3QA",
        "lat": 51.5090832,
        "lng": -0.1969057
    }
];

var mapStyle = [
    {"featureType": "all", "stylers": [
        {"saturation": 0},
        {"hue": "#e53b94"}
    ]},
    {"featureType": "road", "stylers": [
        {"saturation": -70}
    ]},
    {"featureType": "transit", "stylers": [
        {"visibility": "off"}
    ]},
    {"featureType": "poi", "stylers": [
        {"visibility": "off"}
    ]},
    {"featureType": "water", "stylers": [
        {"visibility": "simplified"},
        {"saturation": -60}
    ]}
];

var mapData = {};

angular.module('starter.services')

.factory('Maps', function ($q, $http, $ionicPopup) {

    var deferredInit = $q.defer();
    var currentLoc, myOptions, incidentLocation;

    var getMapWithGPS = function () {
        navigator.geolocation.getCurrentPosition(onGPSSuccess, onGPSError);
        return deferredInit.promise;
    };

    var onGPSSuccess = function (position) {
        incidentLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        myOptions = {
            zoom: 15,
            center: incidentLocation,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: mapStyle,
            disableDefaultUI: true
        };

        currentLoc = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };

        deferredInit.resolve(currentLoc);
    };

    var onGPSError = function (error) {
        deferredInit.reject('code: ' + error.code + '\n' + 'message: ' + error.message + '\n', error);
    };


    function getHeatMapResults() {

        return itsuData

        // return $http.get('http://mapster-panickster.herokuapp.com/heatmap', {params: currentLoc})
        //     .then(function (res) {
        //         console.log(res.data.result);
        //         return res.data.result
        //     }, function(error){
        //         var alertPopup = $ionicPopup.alert({
        //             title: 'Something went wrong while retrieving the location data',
        //             subTitle: 'Displaying map only',
        //             buttons: [
        //                 {
        //                     text: 'OK' ,
        //                     type: 'button-positive button-outline'
        //                 }
        //             ]
        //         });

        //         return alertPopup.then(function (res) {
        //            return [];
        //         });
        //     });
    }

    function processLocationData(res) {
        var locationData = [];
        angular.forEach(res, function (val) {
            locationData.push(
            {
                latlng: new google.maps.LatLng(val.lat, val.lng),
                id: val.id,
                name: val.name,
                address: val.address,
                address2: val.address2,
            });
        });
        return locationData;
    }

    function publishResultsIntoMap(locationData) {
        
        var map = new google.maps.Map(document.getElementById("map"), myOptions);
        var image = 'img/itsu-logo66x66.png';

        var marker = new google.maps.Marker({
            position: incidentLocation,
            draggable: true,
            map: map
        });

        google.maps.event.addListener(marker, 'dragend', function (evt) {
            currentLoc = {
                lat: evt.latLng.lat(),
                lng: evt.latLng.lng()
            };

            console.log('Current Location Updated', currentLoc);
        });

        // var pointArray = new google.maps.MVCArray(locationData);

        // var heatmap = new google.maps.visualization.HeatmapLayer({
        //     data: pointArray
        // });

        // heatmap.setMap(map);

        angular.forEach(locationData, function (val) {
            var marker = new google.maps.Marker({
                position: val.latlng,
                map: map,
                icon: image
            });

            var contentString = '<div id="content">'+
              '<div id="bodyContent">'+
              '<p><b> ' + val.name + ' </b></p>'+
              '<p> ' + val.address + ' </p>'+
              '<p> ' + val.address2 + ' </p>'+
              '</div>'+
              '</div>';

            var infowindow = new google.maps.InfoWindow({
                content: contentString,
                // maxWidth: 200
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.open(map,marker);
            }); 
        });
    }

    return {
        init: function () {
            return getMapWithGPS()
                .then(getHeatMapResults)
                .then(processLocationData)
                .then(publishResultsIntoMap)
                .then(function (data) {
                    console.log('MAP INITIALIZED', currentLoc);
                    return data;
                });
        },
        getCurrentLoc: function () {
            return currentLoc;
        }
    };
});
